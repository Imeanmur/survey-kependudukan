<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Test</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.css" defer>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-section h2 {
            margin-top: 0;
            color: #333;
        }
        canvas {
            max-width: 100%;
            height: 300px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Chart.js Rendering Test</h1>
        
        <div class="chart-section">
            <h2>Chart.js Status</h2>
            <div id="chartStatus" class="status error">Checking Chart.js...</div>
        </div>

        <div class="chart-section">
            <h2>1. Test: Kecamatan Chart</h2>
            <div id="kecamatanStatus" class="status error">Loading...</div>
            <canvas id="testKecamatan"></canvas>
        </div>

        <div class="chart-section">
            <h2>2. Test: Agama Chart</h2>
            <div id="agamaStatus" class="status error">Loading...</div>
            <canvas id="testAgama"></canvas>
        </div>

        <div class="chart-section">
            <h2>API Response Data</h2>
            <h3>Kecamatan API Response:</h3>
            <pre id="kecamatanData" style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;"></pre>
            
            <h3>Agama API Response:</h3>
            <pre id="agamaData" style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;"></pre>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js" defer></script>
    <script defer>
        // Wait for Chart.js
        function waitForChart() {
            return new Promise((resolve) => {
                const startTime = Date.now();
                const check = () => {
                    if (typeof Chart !== 'undefined') {
                        document.getElementById('chartStatus').innerHTML = '‚úÖ Chart.js loaded successfully';
                        document.getElementById('chartStatus').className = 'status success';
                        resolve(true);
                    } else if (Date.now() - startTime < 5000) {
                        setTimeout(check, 100);
                    } else {
                        document.getElementById('chartStatus').innerHTML = '‚ùå Chart.js failed to load';
                        document.getElementById('chartStatus').className = 'status error';
                        resolve(false);
                    }
                };
                check();
            });
        }

        async function runTests() {
            const chartReady = await waitForChart();
            if (!chartReady) return;

            // Test Kecamatan Chart
            try {
                const kecamatanRes = await fetch('./api/data.php?action=get_data_by_kecamatan');
                const kecamatanData = await kecamatanRes.json();
                document.getElementById('kecamatanData').textContent = JSON.stringify(kecamatanData, null, 2);

                if (kecamatanData.success && kecamatanData.data.length > 0) {
                    const labels = kecamatanData.data.map(item => item.kecamatan);
                    const values = kecamatanData.data.map(item => parseInt(item.total_kartu));

                    new Chart(document.getElementById('testKecamatan'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Total Kartu Keluarga',
                                data: values,
                                backgroundColor: '#667eea',
                                borderColor: '#667eea',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 1000,
                                easing: 'easeInOutQuart'
                            }
                        }
                    });
                    
                    document.getElementById('kecamatanStatus').innerHTML = '‚úÖ Chart rendered successfully with ' + labels.length + ' kecamatan';
                    document.getElementById('kecamatanStatus').className = 'status success';
                } else {
                    throw new Error('No data');
                }
            } catch (err) {
                document.getElementById('kecamatanStatus').innerHTML = '‚ùå Error: ' + err.message;
                document.getElementById('kecamatanStatus').className = 'status error';
            }

            // Test Agama Chart
            try {
                const agamaRes = await fetch('./api/data.php?action=get_grafik_agama');
                const agamaData = await agamaRes.json();
                document.getElementById('agamaData').textContent = JSON.stringify(agamaData, null, 2);

                if (agamaData.success && agamaData.labels.length > 0) {
                    new Chart(document.getElementById('testAgama'), {
                        type: 'doughnut',
                        data: {
                            labels: agamaData.labels,
                            datasets: [{
                                label: 'Jumlah Penduduk',
                                data: agamaData.data,
                                backgroundColor: [
                                    '#667eea',
                                    '#764ba2',
                                    '#f093fb',
                                    '#4facfe',
                                    '#00f2fe',
                                    '#43e97b'
                                ],
                                borderColor: 'white',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 1000,
                                easing: 'easeInOutQuart'
                            }
                        }
                    });
                    
                    document.getElementById('agamaStatus').innerHTML = '‚úÖ Chart rendered successfully with ' + agamaData.labels.length + ' agama';
                    document.getElementById('agamaStatus').className = 'status success';
                } else {
                    throw new Error('No data');
                }
            } catch (err) {
                document.getElementById('agamaStatus').innerHTML = '‚ùå Error: ' + err.message;
                document.getElementById('agamaStatus').className = 'status error';
            }
        }

        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>
